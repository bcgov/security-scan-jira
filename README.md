# ACS Scan to Jira Script

Posts newly discovered policy violations in Advanced Cluster Security (ACS) to Jira. Runs in GitHub Actions. Can choose different triggers, but runs every Sunday at 1100 UTC (3:00 - 4:00 AM PT) by default.

## Overview

High-level overview of default behavior:

1. Script queries ACS for any security violations, and saves data as an artifact in GitHub Actions.
2. Time passes while ACS continually and automatically scans for security violations in your environment
3. After a week, the ACS script runs again. Script pulls in new security violations, and compares them to the previous data. If there is a difference between the new and old scan results, ticket will be posted to Jira.

## Prerequsites

Before beginning, you will have to set up a few environment variables.

You will need the following [GitHub Action Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets):

- `GH_TOKEN`: GitHub token used to download artifacts (ie: previous scan results). [Generate a Personal access token here](https://github.com/settings/tokens). Note that the token must have at least all scopes in `repo` section enabled.
- `JIRA_EMAIL`: Email address of account that will post scan results to Jira.
- `JIRA_API_KEY`: Jira API key. This must be generated by the `JIRA_EMAIL` account. [Instructions for generating key](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/).
- `ACS_API_KEY`: API Key for ACS. Keys can be generated [here](https://acs.developer.gov.bc.ca/main/integrations/authProviders/apitoken). Note that certain permissions may be required to create a key. Contact Platform Services about receiving access.
- `JIRA_PROJECT_KEY`: Project key containing your Jira board.

You will also have to update the following variables in the [workflow file](.github/workflows/compare-acs-scans.yml):

- `jobs.build.steps[1].run.REPO`: Set to the name of the repo where this script will run.

Other environment variables are present which you may want to update at a later time. These are typically used for testing/debugging or initial setup. Here are descriptions:

- `ACCEPTED_VULNERABILITIES`: Comma-separated list of violation severity the script will post to Jira, such as LOW, MEDIUM, HIGH, etc. Set to `HIGH,CRITICAL` by default. If you aren't seeing specific issues posted, you may have to update this list.
- `USE_TEST_DATA`: Some sample data is provided if you want to try it out with that first. Set to `true` to enable.
- `JIRA_OPERATION`: Set to either `POST` or `PUT` to perform the respective operation. Can also be set to `NONE` if you would like to perform a dry run.
- `JIRA_PUT_ID`: If using the `PUT` operation, you must provide the key of a ticket you want to update.
- `START_FRESH`: Whether you want to start fresh. If set to `true`, will pull all results from ACS and post those to Jira.

## Recommended Initial Run

The following set of instructions is recommended first steps:

1. Create or update an existing branch in your repo with all the files in this `.github` directory.
2. Update the [workflow file](.github/workflows/compare-acs-scans.yml) to include the branch name in the `on.push.branches` array.
3. Push the branch to your repo.
4. View the GitHub Actions run and ensure there weren't any errors. As this is the first time running, you may see an error in the `build.Download artifact` step. This is expected, as this is the step that checks previous runs for scan results. You should also see new issues in your Jira board with the scan results under Issues.
5. If the Action was successful (aside from the `Download artifact` step), update the workflow so `START_FRESH` is `false`.
6. Push again. This time, all steps should be successful, including `Download artifact`. No new issues (or very few) should be posted to your Jira board.
7. Set up is now complete and will run at the designated schedule time in the workflow file. If you wish, you can remove/comment out the `on.push.branches` section of the workflow, to disable the script from running during each push.
